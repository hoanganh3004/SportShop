<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chi ti·∫øt s·∫£n ph·∫©m</title>
    <link rel="stylesheet" th:href="@{/assets/vendor/css/core.css}" />
    <link rel="stylesheet" th:href="@{/assets/vendor/css/theme-default.css}" />
    <style>
        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .image-preview img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        .file-input-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .file-input-label {
            display: block;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.3s;
        }
        .file-input-label:hover {
            background-color: #0056b3;
        }
        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="modal-header">
    <h5 class="modal-title">Chi ti·∫øt s·∫£n ph·∫©m</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
    <!-- Hi·ªÉn th·ªã th√¥ng b√°o -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle"></i> <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle"></i> <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div th:if="${product != null}">
        <!-- Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt -->
        <div class="mb-3">
            <label class="form-label">·∫¢nh s·∫£n ph·∫©m:</label>
            <style>
                .detail-images { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 8px; }
                .detail-images img { width: 120px; height: 120px; object-fit: cover; border: 2px solid #ddd; border-radius: 5px; }
            </style>
            <div th:if="${product.images != null and !product.images.isEmpty()}" class="detail-images">
                <img th:each="img : ${product.images}"
                     th:src="@{'/images/' + ${img.fileName}}"
                     alt="·∫¢nh s·∫£n ph·∫©m">
            </div>
            <div th:if="${product.images == null or product.images.isEmpty()}" class="text-muted">Kh√¥ng c√≥ ·∫£nh.</div>
        </div>

        <div class="mb-3">
            <label class="form-label">T√™n s·∫£n ph·∫©m:</label>
            <p th:text="${product.name} ?: 'N/A'"></p>
        </div>
        <div class="mb-3">
            <label class="form-label">M√£ SP:</label>
            <p th:text="${product.masp} ?: 'N/A'"></p>
        </div>
        <div class="mb-3">
            <label class="form-label">Gi√°:</label>
            <p th:text="${product.price != null ? #numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT') + '‚Ç´' : 'N/A'}"></p>
        </div>
        <div class="mb-3">
            <label class="form-label">M√¥ t·∫£:</label>
            <p th:text="${product.description} ?: 'N/A'"></p>
        </div>
        <div class="mb-3">
            <label class="form-label">Size:</label>
            <p th:text="${product.size} ?: 'N/A'"></p>
        </div>
        <div class="mb-3">
            <label class="form-label">M√†u s·∫Øc:</label>
            <p th:text="${product.color} ?: 'N/A'"></p>
        </div>
        <div class="mb-3">
            <label class="form-label">S·ªë l∆∞·ª£ng:</label>
            <p th:text="${product.quantity} ?: 0"></p>
        </div>

        <!-- Form ch·ªânh s·ª≠a -->
        <hr>
        <h6>Ch·ªânh s·ª≠a th√¥ng tin</h6>
        <form th:action="@{/adproduct/detail/{id}(id=${product.id})}" method="post" enctype="multipart/form-data" id="updateProductForm">
            <div class="mb-3">
                <label class="form-label">T√™n s·∫£n ph·∫©m</label>
                <input type="text" class="form-control" name="name" th:value="${product.name}" required/>
            </div>
            <div class="mb-3">
                <label class="form-label">M√£ SP</label>
                <input type="text" class="form-control" name="masp" th:value="${product.masp}" required/>
            </div>
            <div class="mb-3">
                <label class="form-label">Gi√°</label>
                <input type="number" class="form-control" name="price" th:value="${product.price}" step="0.01" required/>
            </div>
            <div class="mb-3">
                <label class="form-label">M√¥ t·∫£</label>
                <textarea class="form-control" name="description" th:text="${product.description}"></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label">Size</label>
                <input type="text" class="form-control" name="size" th:value="${product.size}"/>
            </div>
            <div class="mb-3">
                <label class="form-label">M√†u s·∫Øc</label>
                <input type="text" class="form-control" name="color" th:value="${product.color}"/>
            </div>
            <div class="mb-3">
                <label class="form-label">S·ªë l∆∞·ª£ng</label>
                <input type="number" class="form-control" name="quantity" th:value="${product.quantity}" required/>
            </div>
            <div class="mb-3">
                <label class="form-label">Danh m·ª•c</label>
                <select class="form-select" name="categoryId">
                    <option value="">-- Ch·ªçn danh m·ª•c --</option>
                    <option th:each="category : ${categories}"
                            th:value="${category.id}"
                            th:text="${category.name}"
                            th:selected="${product.category != null and product.category.id == category.id}"></option>
                </select>
            </div>

            <!-- Th√™m ·∫£nh m·ªõi -->
            <div class="mb-3">
                <label class="form-label">C·∫≠p nh·∫≠t ·∫£nh s·∫£n ph·∫©m</label>
                <div class="file-input-container">
                    <label for="newImages" class="file-input-label">
                        üì∑ Ch·ªçn ·∫£nh m·ªõi (s·∫Ω thay th·∫ø ·∫£nh c≈©)
                    </label>
                    <input type="file"
                           id="newImages"
                           name="newImages"
                           class="file-input"
                           multiple
                           accept="image/*"
                           onchange="previewImages(this)"/>
                </div>
                <small class="form-text text-muted">
                    ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën thay ƒë·ªïi ·∫£nh. Ch·∫•p nh·∫≠n: JPG, PNG, GIF, BMP, WEBP.
                </small>
                <div id="imagePreview" class="image-preview"></div>
            </div>

            <button type="submit" class="btn btn-primary" id="updateBtn">
                <i class="fas fa-save"></i> L∆∞u thay ƒë·ªïi
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times"></i> ƒê√≥ng
            </button>
        </form>
    </div>

    <div th:if="${product == null and error == null}" class="alert alert-danger">
        S·∫£n ph·∫©m kh√¥ng t·ªìn t·∫°i!
    </div>
</div>

<script>
    function previewImages(input) {
        const preview = document.getElementById('imagePreview');
        preview.innerHTML = '';

        if (input.files) {
            Array.from(input.files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.alt = file.name;
                        img.title = file.name;
                        preview.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // C·∫≠p nh·∫≠t label
        const label = document.querySelector('.file-input-label');
        const fileCount = input.files.length;
        if (fileCount > 0) {
            label.textContent = `üì∑ ƒê√£ ch·ªçn ${fileCount} ·∫£nh m·ªõi`;
        } else {
            label.textContent = 'üì∑ Ch·ªçn ·∫£nh m·ªõi (s·∫Ω thay th·∫ø ·∫£nh c≈©)';
        }
    }

    // X·ª≠ l√Ω form submission cho update
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('updateProductForm');
        const updateBtn = document.getElementById('updateBtn');

        if (form && updateBtn) {
            form.addEventListener('submit', function(e) {
                // Hi·ªÉn th·ªã loading state
                updateBtn.disabled = true;
                updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang c·∫≠p nh·∫≠t...';

                // Validate form tr∆∞·ªõc khi submit
                const name = form.querySelector('input[name="name"]').value.trim();
                const masp = form.querySelector('input[name="masp"]').value.trim();
                const price = form.querySelector('input[name="price"]').value;
                const quantity = form.querySelector('input[name="quantity"]').value;

                if (!name) {
                    e.preventDefault();
                    alert('Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m!');
                    resetUpdateButton();
                    return;
                }

                if (!masp) {
                    e.preventDefault();
                    alert('Vui l√≤ng nh·∫≠p m√£ s·∫£n ph·∫©m!');
                    resetUpdateButton();
                    return;
                }

                if (!price || parseFloat(price) <= 0) {
                    e.preventDefault();
                    alert('Vui l√≤ng nh·∫≠p gi√° s·∫£n ph·∫©m h·ª£p l·ªá!');
                    resetUpdateButton();
                    return;
                }

                if (!quantity || parseInt(quantity) < 0) {
                    e.preventDefault();
                    alert('Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá!');
                    resetUpdateButton();
                    return;
                }
            });

            function resetUpdateButton() {
                updateBtn.disabled = false;
                updateBtn.innerHTML = '<i class="fas fa-save"></i> L∆∞u thay ƒë·ªïi';
            }
        }
    });
</script>
</body>
</html>
