<!-- ================= HEADER ================= -->
<header th:fragment="header">
    <!-- Header desktop -->
    <div class="container-menu-desktop">
        <div class="wrap-menu-desktop">
            <nav class="limiter-menu-desktop container">

                <!-- Logo desktop -->
                <a th:href="@{/home}" class="logo">
                    <img th:src="@{/images/icons/logo-01.png}" alt="IMG-LOGO">
                </a>

                <!-- Menu desktop -->
                <div class="menu-desktop">
                    <ul class="main-menu">
                        <li class="active-menu"><a th:href="@{/home}">Trang chủ</a></li>
                        <li><a th:href="@{/product}">Cửa hàng</a></li>
                        <li><a th:href="@{/blog}">Blog</a></li>
                        <li><a th:href="@{/about}">About</a></li>
                        <li><a th:href="@{/contact}">Liên hệ</a></li>
                    </ul>
                </div>

                <!-- Icon header -->
                <div class="wrap-icon-header flex-w flex-r-m">

                    <!-- Cart -->
                    <div class="icon-header-item cl2 hov-cl1 trans-04 p-l-22 p-r-11 icon-header-noti js-show-cart"
                         th:attr="data-notify=${session.cartQty != null ? session.cartQty : 0}">
                        <i class="zmdi zmdi-shopping-cart"></i>
                    </div>

                    <!-- Notification bell -->
                    <div class="icon-header-item cl2 hov-cl1 trans-04 p-l-22 p-r-11 position-relative icon-header-noti"
                         th:attr="data-notify=${session.notificationCount != null ? session.notificationCount : 0}"
                         id="notification-bell"
                         style="cursor: pointer;">
                        <i class="zmdi zmdi-notifications"></i>

                        <!-- Dropdown notifications -->
                        <div id="notification-dropdown" class="notification-dropdown">
                            <h6 class="p-3 m-0 border-bottom text-center">Thông báo</h6>

                            <div class="notification-list" th:if="${session.notifications != null}">
                                <div th:each="n : ${session.notifications}"
                                     class="notification-item p-2 border-bottom hov-cl1"
                                     th:classappend="${n.read} ? ' read' : ' unread'">
                                    <span th:text="${n.message}">Nội dung thông báo</span>
                                    <small class="d-block text-muted" th:text="${n.createdAt != null ? #temporals.format(n.createdAt, 'dd/MM/yyyy HH:mm') : ''}"></small>
                                </div>
                            </div>

                            <div th:unless="${session.notifications != null}" class="p-3 text-center text-muted">
                                Không có thông báo nào
                            </div>

                        </div>
                    </div>

                    <!-- User account -->
                    <div class="icon-header-item cl2 hov-cl1 trans-04 p-l-22 p-r-11 position-relative" id="user-dropdown">
                        <!-- Khi đã đăng nhập -->
                        <div th:if="${session.loggedInUsername != null}">
                            <div id="user-trigger" class="user-info"
                                 style="cursor: pointer; display: flex; align-items: center;"
                                 tabindex="0" aria-haspopup="true" aria-expanded="false">
                                <i class="zmdi zmdi-account" style="color: #000 !important;"></i>
                                <span th:text="${session.loggedInUsername}" class="user-name ml-2"></span>
                            </div>

                            <!-- Dropdown content -->
                            <div id="user-dropdown-content"
                                 class="user-dropdown-content"
                                 aria-hidden="true">
                                <a th:href="@{/profile}" class="d-block p-2 stext-107 cl2 hov-cl1">Tài khoản của tôi</a>
                                <a th:href="@{/oderhistory}" class="d-block p-2 stext-107 cl2 hov-cl1">Đơn hàng</a>
                                <div class="dropdown-divider"></div>
                                <a th:href="@{/logout}" class="d-block p-2 stext-107 cl2 hov-cl1">Đăng xuất</a>
                            </div>
                        </div>

                        <!-- Khi chưa đăng nhập -->
                        <a th:href="@{/login}" th:unless="${session.loggedInUsername != null}" class="dis-block">
                            <i class="zmdi zmdi-account" style="color: #000 !important;"></i>
                        </a>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <!-- Modal Search -->
    <div class="modal-search-header flex-c-m trans-04 js-hide-modal-search">
        <div class="container-search-header">
            <button class="flex-c-m btn-hide-modal-search trans-04 js-hide-modal-search">
                <img th:src="@{/images/icons/icon-close2.png}" alt="CLOSE">
            </button>
            <form class="wrap-search-header flex-w p-l-15">
                <button class="flex-c-m trans-04"><i class="zmdi zmdi-search"></i></button>
            </form>
        </div>
    </div>

    <!-- Cart -->
    <div class="wrap-header-cart js-panel-cart">
        <div class="s-full js-hide-cart"></div>
        <div class="header-cart flex-col-l p-l-65 p-r-25">
            <div class="header-cart-title flex-w flex-sb-m p-b-8">
                <span class="mtext-103 cl2">Giỏ hàng của bạn</span>
                <div class="fs-35 lh-10 cl2 p-lr-5 pointer hov-cl1 trans-04 js-hide-cart">
                    <i class="zmdi zmdi-close"></i>
                </div>
            </div>
            <div class="header-cart-content flex-w js-pscroll">
                <ul id="header-cart-list" class="header-cart-wrapitem w-full">
                    <!-- Items sẽ được render bằng JS từ /cart/items -->
                </ul>
                <div class="w-full">
                    <div id="header-cart-total" class="header-cart-total w-full p-tb-40"></div>
                    <div class="header-cart-buttons flex-w w-full">
                        <a th:href="@{/checkout}" class="flex-c-m stext-101 cl0 size-107 bg3 bor2 hov-btn3 p-lr-15 trans-04 m-r-8 m-b-10">Xem giỏ hàng</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<script>
    (function() {
        function formatVND(n){ try { return (Number(n)||0).toLocaleString('vi-VN') + 'đ'; } catch(e){ return n; } }
        function updateBadge(total){
            try {
                var el = document.querySelector('.icon-header-noti.js-show-cart');
                if (el) el.setAttribute('data-notify', Number(total||0));
            } catch(e){}
        }
        function renderCart(items){
            var list = document.getElementById('header-cart-list');
            var totalEl = document.getElementById('header-cart-total');
            if (!list || !totalEl) return;
            list.innerHTML = '';
            var total = 0;
            if (Array.isArray(items) && items.length){
                items.forEach(function(it){
                    var p = it && it.product ? it.product : {};
                    var qty = Number(it.quantity||0);
                    var price = Number(p.price||0);
                    total += qty * price;
                    var img = p.firstImageFileName ? ('/images/' + p.firstImageFileName) : '/images/product-01.jpg';
                    var li = document.createElement('li');
                    li.className = 'header-cart-item flex-w flex-t m-b-12';
                    li.setAttribute('data-product-id', p.id || '');
                    li.innerHTML = ''+
                        '<div class="header-cart-item-img">\n'+
                        '  <img src="'+img+'" alt="IMG">\n'+
                        '</div>\n'+
                        '<div class="header-cart-item-txt p-t-8">\n'+
                        '  <a href="#" class="header-cart-item-name m-b-12 hov-cl1 trans-04">'+ (p.name||'Sản phẩm') +'</a>\n'+
                        '  <span class="header-cart-item-info d-block m-b-8">'+ qty +' x '+ formatVND(price) +'</span>\n'+
                        '  <div class="header-cart-item-actions flex-w flex-m">\n'+
                        '    <button class="btn-dec cl2 hov-cl1 trans-04 bor13 size-28 m-r-8" aria-label="Giảm">−</button>\n'+
                        '    <input class="num-product stext-104 cl3 size-28 bor13 m-r-8 text-center" type="text" value="'+ qty +'" readonly>\n'+
                        '    <button class="btn-inc cl2 hov-cl1 trans-04 bor13 size-28 m-r-12" aria-label="Tăng">+</button>\n'+
                        '    <button class="btn-remove cl2 hov-cl1 trans-04" aria-label="Xóa"><i class="zmdi zmdi-delete"></i></button>\n'+
                        '  </div>\n'+
                        '</div>';
                    list.appendChild(li);
                });
            } else {
                var empty = document.createElement('li');
                empty.className = 'p-2 text-muted';
                empty.textContent = 'Giỏ hàng trống';
                list.appendChild(empty);
            }
            totalEl.textContent = 'Tổng cộng: ' + formatVND(total);
        }
        function loadCart(){
            fetch('/cart/items', { method: 'GET', credentials: 'same-origin' })
                .then(function(r){ return r.text(); })
                .then(function(t){ try { return JSON.parse(t); } catch(e){ return []; } })
                .then(function(items){
                    renderCart(items);
                    var sum = 0; if (Array.isArray(items)) items.forEach(function(it){ sum += Number(it.quantity||0); });
                    updateBadge(sum);
                })
                .catch(function(){});
        }
        function post(url, data){
            var form = new URLSearchParams();
            Object.keys(data||{}).forEach(function(k){ if (data[k] !== undefined) form.append(k, data[k]); });
            return fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' }, body: form, credentials: 'same-origin' })
                .then(function(r){
                    if (!r.ok) {
                        return r.text().then(function(t){
                            if (r.status === 409) {
                                alert('Không thể vượt quá sản phẩm trong kho');
                            }
                            return '0';
                        });
                    }
                    return r.text();
                })
                .then(function(t){ var n = Number(t); return isNaN(n) ? 0 : n; });
        }
        document.addEventListener('click', function(e){
            var inc = e.target.closest && e.target.closest('.btn-inc');
            var dec = e.target.closest && e.target.closest('.btn-dec');
            var rm  = e.target.closest && e.target.closest('.btn-remove');
            if (!(inc||dec||rm)) return;
            e.preventDefault();
            var itemEl = e.target.closest('.header-cart-item');
            if (!itemEl) return;
            var productId = itemEl.getAttribute('data-product-id');
            if (!productId) return;
            if (inc) {
                post('/cart/increase', { productId: productId })
                    .then(function(){ loadCart(); })
                    .catch(function(){});
                return;
            }
            if (dec) {
                var qtyInput = itemEl.querySelector('input.num-product');
                var current = Number((qtyInput && qtyInput.value) || '1');
                if (current <= 1) { alert('Không thể giảm dưới 1'); return; } // chặn giảm < 1 ở client + thông báo
                post('/cart/decrease', { productId: productId })
                    .then(function(){ loadCart(); })
                    .catch(function(){});
                return;
            }
            if (rm) {
                if (!confirm('Bạn có chắc chắn muốn xóa sản phẩm này khỏi giỏ hàng?')) return;
                post('/cart/remove', { productId: productId })
                    .then(function(){ loadCart(); })
                    .catch(function(){});
                return;
            }
        }, false);
        // Load when panel opens
        document.addEventListener('click', function(e){
            var btn = e.target.closest && e.target.closest('.js-show-cart');
            if (btn) { setTimeout(loadCart, 0); }
        }, false);
        // Initial sync
        try { setTimeout(loadCart, 0); } catch(e) {}
    })();
</script>

<style>
    /* Dropdown thông báo: đẹp hơn, dễ đọc, không ảnh hưởng logic */
    #notification-dropdown.notification-dropdown{
        position: absolute;
        right: 0;
        top: 140%;
        width: 320px;
        background: #fff;
        border: 1px solid rgba(0,0,0,0.06);
        border-radius: 10px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        z-index: 1000;
        overflow: hidden;
    }
    #notification-dropdown .notification-list{
        max-height: 360px;
        overflow-y: auto;
    }
    #notification-dropdown h6{
        font-size: 14px;
        font-weight: 600;
        color: #444;
        background: #f9fafb;
    }
    #notification-dropdown .notification-item{
        background: #fff;
        transition: background 0.2s ease;
    }
    #notification-dropdown .notification-item:hover{
        background: #f6f7f9;
    }
    #notification-dropdown .notification-item span{
        font-size: 13px; /* nhỏ hơn cho dễ nhìn */
        color: #111;
        line-height: 1.35;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    #notification-dropdown .notification-item small{
        font-size: 12px;
        color: #6b7280 !important;
        margin-top: 4px;
    }
    /* Phân biệt đã đọc/chưa đọc */
    #notification-dropdown .notification-item.unread{
        background: #f0f7ff;
        border-left: 3px solid #3b82f6; /* xanh nhấn */
    }
    #notification-dropdown .notification-item.read{
        opacity: 0.8;
    }
    /* Badge số lượng trên chuông: thu nhỏ cho cân đối */
    #notification-bell.icon-header-noti::after{
        font-size: 10px;
        min-width: 16px;
        height: 16px;
        line-height: 16px;
        top: -6px;
        right: -6px;
    }
</style>
